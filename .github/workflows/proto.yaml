# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Compile Protos PR

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize]

jobs:
  compile-protos-pr:
    # Check if the PR is not raised by this workflow and is not from a fork
    if: startsWith(github.head_ref, 'gen-proto/') == false && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write # Needed to comment on the original PR

    steps:
      - name: Checkout Original PR
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0 # Needed to carry over the history
          persist-credentials: false

      - name: Attach to Original Branch
        # 1. FIX: Switch from "Detached HEAD" to the actual branch name.
        # This ensures the new PR will include all your original commits.
        run: |
          git checkout -B ${{ github.head_ref }} origin/${{ github.head_ref }}
          
          echo "Currently on branch:"
          git branch --show-current
          echo "Recent history:"
          git log -3 --oneline

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "33.3"

      - name: Generate Protos
        run: |
          rm -rf compiled_proto
          mkdir compiled_proto
          protoc --cpp_out=compiled_proto connections/implementation/proto/offline_wire_formats.proto internal/proto/analytics/connections_log.proto internal/proto/credential.proto internal/proto/local_credential.proto internal/proto/metadata.proto proto/errorcode/error_code_enums.proto proto/mediums/ble_frames.proto proto/mediums/multiplex_frames.proto proto/mediums/nfc_frames.proto proto/mediums/web_rtc_signaling_frames.proto proto/connections_enums.proto proto/sharing_enums.proto sharing/proto/analytics/nearby_sharing_log.proto
          ls -lR compiled_proto

      - name: Create Superseding PR
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          # Create a new branch based on the Original PR + Protos
          branch: gen-proto/${{ github.head_ref }}
          # CRITICAL: Target 'main', not the original PR branch
          base: main
          delete-branch: true
          title: "üöÄ Complete: ${{ github.event.pull_request.title }}"
          body: |
            This PR supersedes #${{ github.event.pull_request.number }}.
            
            It includes the original code changes **plus** the compiled protobufs required for GitHub builds.
            
            **Workflow:**
            1. Copybara imports *this* PR internally (stripping protos).
            2. Internal CL is submitted.
            3. PR #${{ github.event.pull_request.number }} will be abandoned.
          commit-message: "chore: add compiled protobufs"
          labels: "ready-for-import"

      - name: Notify Original PR
        if: steps.cpr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "‚ö†Ô∏è **Action Required**\n\nA superseding PR has been created with compiled protos: #${{ steps.cpr.outputs.pull-request-number }}.\n\nPlease review/import that PR instead."
            })
